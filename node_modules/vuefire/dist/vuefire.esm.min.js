/*!
  * vuefire v2.1.0
  * (c) 2019 Eduardo San Martin Morote
  * @license MIT
  */
function e(e,t,n){const s=(""+t).split("."),r=s.pop(),i=s.reduce((e,t)=>e[t],e);return Array.isArray(i)?i.splice(Number(r),1,n):i[r]=n}function t(e){return e&&"object"==typeof e}function n(e){return e.toDate}function s(e,t){for(let n=0;n<e.length;n++)if(e[n][".key"]===t)return n;return-1}const r={reset:!0,serialize:function(e){const n=e.val(),s=t(n)?n:Object.defineProperty({},".value",{value:n});return Object.defineProperty(s,".key",{value:e.key}),s}};function i(e,s={},r="",o=[{},{}]){s=s||{};const c=Object.getOwnPropertyDescriptor(e,"id");c&&!c.enumerable&&Object.defineProperty(o[0],"id",c);const[l,f]=o;for(const o in e){const c=e[o];if((a=c)&&a.onSnapshot)l[o]=s[o]||c.path,f[r+o]=c;else if(Array.isArray(c)){l[o]=Array(c.length).fill(null);const e=(s[o]||[]).filter(e=>-1!==c.indexOf(e));i(c,e,r+o+".",[l[o],f])}else null==c||c instanceof Date||n(c)||c.longitude&&c.latitude?l[o]=c:t(c)?(l[o]={},i(c,s[o],r+o+".",[l[o],f])):l[o]=c}var a;return o}const o={maxRefDepth:2,reset:!0,serialize:function(e){return Object.defineProperty(e.data(),"id",{value:e.id})}};function c(e){for(const t in e)e[t].unsub()}function l({snapshot:e,target:t,path:n,subs:s,ops:r,depth:o,resolve:c},l){const[f,d]=i(e,function(e,t){return t.split(".").reduce((e,t)=>e[t],e)}(t,n));r.set(t,n,f),a({subs:s,refs:d,target:t,path:n,ops:r,depth:o,resolve:c},l)}function f({ref:e,target:t,path:n,depth:s,resolve:r,ops:i},o){const f=Object.create(null),a=e.onSnapshot(e=>{e.exists?l({snapshot:o.serialize(e),target:t,path:n,ops:i,subs:f,depth:s,resolve:r},o):(i.set(t,n,null),r(n))});return()=>{a(),c(f)}}function a({subs:e,refs:t,target:n,path:s,depth:r,ops:i,resolve:o},c){const l=Object.keys(t);if(Object.keys(e).filter(e=>l.indexOf(e)<0).forEach(t=>{e[t].unsub(),delete e[t]}),!l.length||++r>c.maxRefDepth)return o(s);let a=0;const d=l.length,u=Object.create(null);function p(e){e in u&&++a>=d&&o(s)}l.forEach(o=>{const l=e[o],a=t[o],d=`${s}.${o}`;if(u[d]=!0,l){if(l.path===a.path)return;l.unsub()}e[o]={unsub:f({ref:a,target:n,path:d,depth:r,ops:i,resolve:p.bind(null,d)},c),path:a.path}})}const d={set:(t,n,s)=>e(t,n,s),add:(e,t,n)=>e.splice(t,0,n),remove:(e,t)=>e.splice(t,1)};function u(e,t,n,i){return new Promise((o,c)=>{let l;l=Array.isArray(e[t])?function({vm:e,key:t,collection:n,resolve:i,reject:o,ops:c},l=r){const f=Object.assign({},r,l),a=[];c.set(e,t,a);const d=n.on("child_added",(e,t)=>{const n=t?s(a,t)+1:0;c.add(a,n,f.serialize(e))},o),u=n.on("child_removed",e=>{c.remove(a,s(a,e.key))},o),p=n.on("child_changed",e=>{c.set(a,s(a,e.key),f.serialize(e))},o),b=n.on("child_moved",(e,t)=>{const n=s(a,e.key),r=c.remove(a,n)[0],i=t?s(a,t)+1:0;c.add(a,i,r)},o);return n.once("value",i),()=>{if(n.off("child_added",d),n.off("child_changed",p),n.off("child_removed",u),n.off("child_moved",b),!1!==f.reset){const n="function"==typeof f.reset?f.reset():[];c.set(e,t,n)}}}({vm:e,key:t,collection:n,resolve:o,reject:c,ops:d},i):function({vm:e,key:t,document:n,resolve:s,reject:i,ops:o},c=r){const l=Object.assign({},r,c),f=n.on("value",n=>{o.set(e,t,l.serialize(n))},i);return n.once("value",s),()=>{if(n.off("value",f),!1!==l.reset){const n="function"==typeof l.reset?l.reset():null;o.set(e,t,n)}}}({vm:e,key:t,document:n,resolve:o,reject:c,ops:d},i),e._firebaseUnbinds[t]=l})}const p={bindName:"$rtdbBind",unbindName:"$rtdbUnbind",serialize:r.serialize},b=function(e,t=p){const n=e.config.optionMergeStrategies;n.firebase=n.provide;const s=Object.assign({},p,t),{bindName:r,unbindName:i}=s;e.prototype[r]=function(e,t,n=s){const r=Object.assign({},s,n);this._firebaseUnbinds[e]&&this[i](e);const o=u(this,e,t,r);return this._firebaseSources[e]=t,this.$firebaseRefs[e]=t.ref,o},e.prototype[i]=function(e){!function(e,t){e._firebaseUnbinds[t](),delete e._firebaseSources[t],delete e._firebaseUnbinds[t]}(this,e)},e.mixin({beforeCreate(){this.$firebaseRefs=Object.create(null),this._firebaseSources=Object.create(null),this._firebaseUnbinds=Object.create(null)},created(){let e=this.$options.firebase;if("function"==typeof e&&(e=e.call(this)),e)for(const t in e)this[r](t,e[t],s)},beforeDestroy(){for(const e in this._firebaseUnbinds)this._firebaseUnbinds[e]();this._firebaseSources=null,this._firebaseUnbinds=null,this.$firebaseRefs=null}})},h={set:(t,n,s)=>e(t,n,s),add:(e,t,n)=>e.splice(t,0,n),remove:(e,t)=>e.splice(t,1)};function v(e,t,n,s,r){return new Promise((f,d)=>{let u;u="where"in n?function({vm:e,key:t,collection:n,ops:s,resolve:r,reject:l},f=o){const d=Object.assign({},o,f),u=s.set(e,t,[]),p=r;let b;const h=[],v={added:({newIndex:e,doc:t})=>{h.splice(e,0,Object.create(null));const n=h[e],o=d.serialize(t),[c,l]=i(o);s.add(u,e,c),a({refs:l,subs:n,target:u,path:e,depth:0,ops:s,resolve:r.bind(null,t)},d)},modified:({oldIndex:e,newIndex:t,doc:n})=>{const o=h.splice(e,1)[0];h.splice(t,0,o);const c=s.remove(u,e)[0],l=d.serialize(n),[f,p]=i(l,c);s.add(u,t,f),a({refs:p,subs:o,ops:s,target:u,path:t,depth:0,resolve:r},d)},removed:({oldIndex:e})=>{s.remove(u,e),c(h.splice(e,1)[0])}},y=n.onSnapshot(n=>{const s="function"==typeof n.docChanges?n.docChanges():n.docChanges;if(!b&&s.length){b=!0;let n=0;const i=s.length,o=Object.create(null);for(let e=0;e<i;e++)o[s[e].doc.id]=!0;r=({id:s})=>{s in o&&++n>=i&&(p(e[t]),r=()=>{})}}s.forEach(e=>{v[e.type](e)}),s.length||r()},l);return()=>{if(y(),!1!==d.reset){const n="function"==typeof d.reset?d.reset():[];s.set(e,t,n)}h.forEach(c)}}({vm:e,key:t,ops:s,collection:n,resolve:f,reject:d},r):function({vm:e,key:t,document:n,resolve:s,reject:r,ops:i},f=o){const a=Object.assign({},o,f),d=Object.create(null);s=function(e,t){let n=!1;return()=>{if(!n)return n=!0,e(t())}}(s,()=>e[t]);const u=n.onSnapshot(n=>{n.exists?l({snapshot:a.serialize(n),target:e,path:t,subs:d,ops:i,depth:0,resolve:s},a):s()},r);return()=>{if(u(),!1!==a.reset){const n="function"==typeof a.reset?a.reset():null;i.set(e,t,n)}c(d)}}({vm:e,key:t,ops:s,document:n,resolve:f,reject:d},r),e._firestoreUnbinds[t]=u})}const y={bindName:"$bind",unbindName:"$unbind",serialize:o.serialize},m=function(e,t=y){const n=e.config.optionMergeStrategies;n.firestore=n.provide;const s=Object.assign({},y,t),{bindName:r,unbindName:i}=s;e.prototype[r]=function(e,t,n=s){const r=Object.assign({},s,n);this._firestoreUnbinds[e]&&this[i](e);const o=v(this,e,t,h,r);return this.$firestoreRefs[e]=t,o},e.prototype[i]=function(e){this._firestoreUnbinds[e](),delete this._firestoreUnbinds[e],delete this.$firestoreRefs[e]},e.mixin({beforeCreate(){this._firestoreUnbinds=Object.create(null),this.$firestoreRefs=Object.create(null)},created(){const{firestore:e}=this.$options,t="function"==typeof e?e.call(this):e;if(t)for(const e in t)this[r](e,t[e],s)},beforeDestroy(){for(const e in this._firestoreUnbinds)this._firestoreUnbinds[e]();this._firestoreUnbinds=null,this.$firestoreRefs=null}})};export{m as firestorePlugin,b as rtdbPlugin,e as walkSet};
